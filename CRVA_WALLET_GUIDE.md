# 🔐 CRVA 多签钱包完整使用指南

## 📖 目录
1. [什么是 CRVA 多签钱包](#什么是-crva-多签钱包)
2. [创建 CRVA 钱包](#创建-crva-钱包)
3. [发起多签交易](#发起多签交易)
4. [完整验证流程](#完整验证流程)
5. [技术架构](#技术架构)
6. [安全保障](#安全保障)
7. [常见问题](#常见问题)

---

## 什么是 CRVA 多签钱包

### 🎯 核心概念

**CRVA (Crypto Ring Verifiable Authentication)** 是一种创新的多签验证方案：

- **隐私保护**：验证节点身份完全匿名
- **去中心化**：无单点控制，VRF 随机选取
- **高安全性**：TEE + 门限签名 + 零知识证明
- **用户友好**：只需普通转账操作

### 🆚 与传统多签的区别

| 特性 | 传统多签 | CRVA 多签 |
|------|---------|----------|
| **验证者身份** | 公开可见 | 完全隐私 |
| **选取方式** | 固定成员 | VRF 随机 |
| **密钥管理** | 固定私钥 | 临时密钥轮换 |
| **隐私保护** | 无 | TEE + ZK 证明 |
| **用户体验** | 需多方协调 | 自动化验证 |

---

## 创建 CRVA 钱包

### 步骤 1: 进入创建界面

```
在钱包应用中:
1. 点击首页的 "+" 或 "添加钱包" 按钮
2. 选择 "创建新钱包"
3. 选择钱包类型：CRVA 多签钱包
```

**界面示例**：
```
┌─────────────────────────────────┐
│  选择钱包类型                    │
├─────────────────────────────────┤
│  ○ 热钱包  (随时使用)           │
│  ○ 冷钱包  (安全存储)           │
│  ○ 观测钱包 (只看不花)          │
│  ● CRVA多签 (隐私保护+多重验证) │
└─────────────────────────────────┘
```

### 步骤 2: 选择区块链网络

```
支持的网络:
- Ethereum (主网/Sepolia测试网)
- 未来支持：Bitcoin, BSC, Polygon 等
```

**配置示例**：
```
┌─────────────────────────────────┐
│  选择网络                        │
├─────────────────────────────────┤
│  区块链: Ethereum               │
│  网络: Mainnet / Sepolia        │
│  合约: 0xe7f1725E7734CE288...   │
└─────────────────────────────────┘
```

### 步骤 3: 配置验证参数

**推荐配置**：
```
┌─────────────────────────────────┐
│  CRVA 验证参数                   │
├─────────────────────────────────┤
│  钱包名称: 我的CRVA钱包         │
│  最少验证节点: 5 个              │
│  委员会轮换: 每 1 小时           │
│  验证节点池: 50+ 节点 ✅         │
│  Ring VRF: 已配置 ✅             │
└─────────────────────────────────┘
```

### 步骤 4: 创建钱包密钥

```
系统会自动：
1. 生成助记词（12/24词）
2. 派生私钥和公钥
3. 生成钱包地址
4. 在链上注册公钥哈希
```

**创建流程**：
```
生成助记词 → 派生密钥 → 计算地址 → 链上注册
    ↓           ↓          ↓          ↓
  12词备份    加密存储   ETH地址   公钥哈希
```

### 步骤 5: 备份助记词（重要！）

```
⚠️ 请务必安全备份您的助记词！

┌─────────────────────────────────┐
│  您的助记词（顺序很重要）       │
├─────────────────────────────────┤
│  1. abandon    7. habit          │
│  2. ability    8. harvest        │
│  3. able       9. hazard         │
│  4. about     10. head           │
│  5. above     11. health         │
│  6. absent    12. heart          │
└─────────────────────────────────┘

□ 我已安全备份助记词
□ 我理解丢失助记词将无法恢复资产
```

---

## 发起多签交易

### 场景示例：发送 1 ETH 给朋友

### 步骤 1: 准备交易

**发送界面**：
```
┌─────────────────────────────────┐
│  发送 ETH                        │
├─────────────────────────────────┤
│  从: 我的CRVA钱包               │
│      0x742d...0bEb              │
│                                  │
│  到: 0x123...789                │
│                                  │
│  金额: 1.0 ETH                  │
│                                  │
│  手续费: 0.002 ETH              │
│  CRVA验证费: 0.0001 ETH         │
│  ────────────────────            │
│  总计: 1.0021 ETH               │
│                                  │
│  备注(可选): 还你的咖啡钱 ☕    │
│                                  │
│  [ 下一步 ]                     │
└─────────────────────────────────┘
```

### 步骤 2: 签名交易

**签名确认**：
```
┌─────────────────────────────────┐
│  确认交易                        │
├─────────────────────────────────┤
│  您正在发送:                     │
│                                  │
│  💰 1.0 ETH                     │
│  📤 到: 0x123...789             │
│  ⛽ 手续费: 0.002 ETH           │
│                                  │
│  🔐 CRVA 验证流程:              │
│  • 您签名 (本地)                 │
│  • 5个节点随机验证 (链上)        │
│  • 达成共识后自动执行            │
│                                  │
│  预计时间: 2-5 分钟              │
│                                  │
│  输入密码确认:                   │
│  [__________]                    │
│                                  │
│  [ 确认签名 ]  [ 取消 ]         │
└─────────────────────────────────┘
```

### 步骤 3: 提交到 CRVA 网络

**提交成功**：
```
┌─────────────────────────────────┐
│  ✅ 交易已提交                  │
├─────────────────────────────────┤
│  提案ID: #12345                 │
│  状态: 等待CRVA验证...          │
│                                  │
│  验证进度:                       │
│  ●●●○○○○○ 3/5 已验证           │
│                                  │
│  预计完成: 3 分钟后              │
│                                  │
│  [ 查看详情 ]                   │
└─────────────────────────────────┘
```

---

## 完整验证流程

### 🔄 7个阶段详解

#### **阶段 1: 节点质押和注册**
```
用户创建钱包时（后台自动）：
┌───────────────────────────────────┐
│ 1. 连接到验证节点网络              │
│ 2. 检查可用节点（需>50个）         │
│ 3. 验证节点已在链上质押(10 ETH)    │
│ 4. 确认节点信誉分数(>5000/10000)   │
└───────────────────────────────────┘

节点状态示例：
┌──────┬──────────┬────────┬──────┐
│节点ID│ 质押金额  │ 信誉分 │ 状态 │
├──────┼──────────┼────────┼──────┤
│node_1│ 10.0 ETH │ 8500   │ ✅   │
│node_2│ 10.0 ETH │ 9200   │ ✅   │
│node_3│ 10.0 ETH │ 7800   │ ✅   │
│...   │ ...      │ ...    │ ...  │
└──────┴──────────┴────────┴──────┘
总计: 52 个活跃节点
```

#### **阶段 2: 临时密钥生成（TEE内）**
```
每个节点（每小时自动）：
┌───────────────────────────────────┐
│ [TEE 内部 - 外部不可见]            │
│                                    │
│ 1. 生成临时密钥对                  │
│    Private: [隐藏]                │
│    Public:  0xabc...def           │
│                                    │
│ 2. 生成 ZK 证明                   │
│    证明: 临时公钥 ↔ 永久公钥       │
│    但不泄露永久公钥                │
│                                    │
│ 3. 加密临时公钥                   │
│    只有 Relayer 能解密            │
└───────────────────────────────────┘

输出: 加密的临时公钥 + ZK 证明
```

#### **阶段 3: Relayer 解密（TEE内）**
```
Relayer 节点：
┌───────────────────────────────────┐
│ [Relayer TEE 内部]                 │
│                                    │
│ 接收到 52 个加密的临时公钥         │
│                                    │
│ 📥 for each 加密包:                │
│    ├─ 1. TEE内解密                │
│    ├─ 2. 验证 ZK 证明              │
│    ├─ 3. 确认节点身份              │
│    └─ 4. 添加到候选池              │
│                                    │
│ ✅ 验证通过: 48/52 个              │
└───────────────────────────────────┘

结果: 48 个有效的临时公钥列表
```

#### **阶段 4: VRF 随机选取委员会**
```
智能合约自动执行：
┌───────────────────────────────────┐
│ Ring VRF 随机选取算法              │
│                                    │
│ 输入:                              │
│  • 48 个候选节点                   │
│  • 区块哈希作为随机种子            │
│  • 需要选取 5 个节点               │
│                                    │
│ 算法:                              │
│  1. seed = blockhash               │
│  2. Fisher-Yates 洗牌算法          │
│  3. 选取前 5 个                    │
│                                    │
│ 输出: 委员会成员                   │
│  [node_15, node_7, node_33,       │
│   node_41, node_9]                 │
└───────────────────────────────────┘

🔐 完全随机、不可预测、可验证
```

**用户看到的进度**：
```
┌─────────────────────────────────┐
│  CRVA 验证进行中...             │
├─────────────────────────────────┤
│  ✅ 阶段1: 委员会已选取 (5节点) │
│  ⏳ 阶段2: 等待验证结果...      │
│                                  │
│  选中的节点:                     │
│  • Node #15 ●                    │
│  • Node #7  ○ (验证中)          │
│  • Node #33 ○                    │
│  • Node #41 ○                    │
│  • Node #9  ○                    │
│                                  │
│  进度: █████░░░░░ 1/5            │
└─────────────────────────────────┘
```

#### **阶段 5: 节点身份核对（TEE内）**
```
每个选中的节点：
┌───────────────────────────────────┐
│ [Node TEE 内部]                    │
│                                    │
│ 📨 收到: 委员会名单 [5个公钥]      │
│                                    │
│ 🔍 检查: 我的临时公钥在列表中吗?   │
│                                    │
│ if (my_ephemeral_key in list):    │
│   ✅ 我被选中了!                  │
│   → 进入验证模式                  │
│   → 开始接收待验证交易            │
│ else:                              │
│   ○ 继续待命                      │
└───────────────────────────────────┘

🔐 整个过程对外不可见，保护节点隐私
```

#### **阶段 6: 交易验证和签名**
```
每个委员会节点（TEE内）：
┌───────────────────────────────────┐
│ 接收交易数据:                      │
│  From: 0x742d...0bEb              │
│  To:   0x123...789                │
│  Value: 1.0 ETH                   │
│  Signature: 0xabc...def           │
│                                    │
│ 验证步骤:                          │
│  ✓ 1. 签名验证                    │
│     └─ 确认发送者确实签名了        │
│  ✓ 2. 余额验证                    │
│     └─ 确认账户有足够余额          │
│  ✓ 3. Nonce 验证                  │
│     └─ 防止重放攻击                │
│  ✓ 4. Gas 验证                    │
│     └─ 确认有足够 gas              │
│  ✓ 5. 合规性检查（可选）           │
│     └─ 黑名单、限额等              │
│                                    │
│ 生成门限签名分片:                  │
│  Share_1 = sign(tx_hash, temp_key)│
└───────────────────────────────────┘

每个节点生成一个签名分片
```

**用户看到的验证进度**：
```
┌─────────────────────────────────┐
│  CRVA 验证进行中...             │
├─────────────────────────────────┤
│  选中的节点:                     │
│  • Node #15 ✅ 已验证通过        │
│  • Node #7  ✅ 已验证通过        │
│  • Node #33 ✅ 已验证通过        │
│  • Node #41 ⏳ 验证中...        │
│  • Node #9  ○ 等待中            │
│                                  │
│  进度: ████████░░ 3/5            │
│                                  │
│  最少需要: 4/5 签名               │
│  预计完成: 2 分钟                │
└─────────────────────────────────┘
```

#### **阶段 7: 签名聚合和执行**
```
智能合约自动：
┌───────────────────────────────────┐
│ 📨 收集签名分片:                   │
│    Share_1: 0xaa...bb (Node #15)  │
│    Share_2: 0xcc...dd (Node #7)   │
│    Share_3: 0xee...ff (Node #33)  │
│    Share_4: 0x11...22 (Node #41)  │
│                                    │
│ 🔧 聚合签名:                       │
│    Final_Sig = aggregate(shares)  │
│    Result: 0x9876...5432          │
│                                    │
│ ✅ 达到阈值 (4/5)                 │
│                                    │
│ 🚀 执行交易:                       │
│    • 从钱包扣款 1.0 ETH           │
│    • 转账到目标地址                │
│    • 扣除 gas 费                  │
│    • 记录交易哈希                  │
└───────────────────────────────────┘

交易哈希: 0xabcdef123456...
```

**最终成功提示**：
```
┌─────────────────────────────────┐
│  ✅ 交易已执行成功!              │
├─────────────────────────────────┤
│  发送金额: 1.0 ETH               │
│  收款地址: 0x123...789           │
│  手续费: 0.002 ETH               │
│                                  │
│  CRVA 验证:                      │
│  • 5 个节点随机选中               │
│  • 4/5 节点验证通过 ✅           │
│  • 验证耗时: 3分12秒              │
│                                  │
│  交易哈希:                       │
│  0xabcdef123456...               │
│                                  │
│  [ 在区块浏览器查看 ]            │
│  [ 分享 ]  [ 完成 ]              │
└─────────────────────────────────┘
```

---

## 技术架构

### 🏗️ 系统组件

```
┌─────────────────────────────────────────┐
│           客户端钱包 (前端)              │
│  • React Native / Web                   │
│  • 本地签名                             │
│  • 交易提交                             │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│        智能合约 (Ethereum/BSC)           │
│  ┌────────────────────────────────────┐ │
│  │ CRVARegistry (节点注册表)          │ │
│  │  • 节点注册/注销                   │ │
│  │  • 质押管理(10 ETH)                │ │
│  │  • 信誉系统(0-10000)               │ │
│  └────────────────────────────────────┘ │
│  ┌────────────────────────────────────┐ │
│  │ CRVACommittee (委员会管理)         │ │
│  │  • 临时公钥提交                    │ │
│  │  • VRF 随机选取                    │ │
│  │  • 委员会轮换(1小时)               │ │
│  └────────────────────────────────────┘ │
│  ┌────────────────────────────────────┐ │
│  │ ThresholdSignature (门限签名)      │ │
│  │  • 交易提案                        │ │
│  │  • 签名分片提交                    │ │
│  │  • 签名聚合和执行                  │ │
│  └────────────────────────────────────┘ │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│         后端服务 (Node.js)               │
│  ┌────────────────────────────────────┐ │
│  │ REST API                           │ │
│  │  • 节点管理                        │ │
│  │  • 交易查询                        │ │
│  │  • 委员会状态                      │ │
│  └────────────────────────────────────┘ │
│  ┌────────────────────────────────────┐ │
│  │ WebSocket 服务器                   │ │
│  │  • 实时验证进度推送                │ │
│  │  • 委员会变更通知                  │ │
│  └────────────────────────────────────┘ │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│        验证节点网络 (50+ 节点)           │
│  ┌────────────────────────────────────┐ │
│  │ CRVA Node (验证节点)               │ │
│  │  • TEE 环境 (Intel SGX/AWS Nitro) │ │
│  │  • 临时密钥生成                    │ │
│  │  • 交易验证                        │ │
│  │  • 门限签名生成                    │ │
│  └────────────────────────────────────┘ │
│  ┌────────────────────────────────────┐ │
│  │ CRVA Relayer (中继节点)            │ │
│  │  • TEE 内解密                      │ │
│  │  • ZK 证明验证                     │ │
│  │  • 临时公钥揭示                    │ │
│  └────────────────────────────────────┘ │
└─────────────────────────────────────────┘
```

---

## 安全保障

### 🔒 多层安全机制

#### 1. **TEE 可信执行环境**
- ✅ 物理隔离
- ✅ 内存加密
- ✅ 远程认证
- ✅ 密封存储

#### 2. **零知识证明**
- 证明：临时公钥与永久公钥有关联
- 不透露：具体是哪个永久公钥

#### 3. **Ring VRF 随机性**
- ✅ 真随机（基于区块哈希）
- ✅ 不可预测
- ✅ 可验证
- ✅ 抗操纵

#### 4. **门限签名 (4/5)**
- 单个签名分片无用
- 需要 k/n 个分片才能聚合
- 分片丢失不影响安全性
- 没有单点故障

#### 5. **经济激励**
- 每个节点质押 10 ETH
- 作恶会被 slash (罚没质押)
- 信誉分数影响选中概率
- 良好行为获得奖励

---

## 常见问题

### ❓ Q1: 验证需要多长时间？

**A**: 典型流程耗时 **2-5 分钟**
- 用户签名: 1-2 秒
- 提交交易: 2-3 秒
- VRF 选取: 30 秒
- TEE 验证: 1-3 分钟
- 签名聚合: 10-20 秒
- 交易执行: 30-60 秒

### ❓ Q2: 手续费比普通转账高多少？

**A**: 额外成本约 **$5-8**
- 普通转账: ~$3
- CRVA 转账: ~$8-11（包含验证费）

### ❓ Q3: CRVA 适合什么场景？

**推荐**：
- ✅ 高价值资产 ($10万+)
- ✅ 企业资金管理
- ✅ DAO 国库
- ✅ 需要隐私保护的场景

**不推荐**：
- ❌ 日常小额支付
- ❌ 需要即时到账
- ❌ 测试/开发用途

### ❓ Q4: 可以切换到普通钱包吗？

**A**: ✅ **可以！**
1. 导出助记词/私钥
2. 导入到任何支持 ETH 的钱包
3. 作为普通钱包使用（但失去 CRVA 保护）

### ❓ Q5: 如何成为验证节点？

**要求**：
- 质押 10 ETH
- 支持 TEE 的硬件（Intel SGX/AWS Nitro）
- 稳定网络连接
- 24/7 运行

**收益**：
- 月收益约 $200-300

详见：`server/README.md`

---

## 📚 相关文档

- [智能合约文档](contracts/README.md)
- [后端服务文档](server/README.md)
- [部署指南](contracts/DEPLOYMENT.md)
- [项目总览](START_HERE.md)

---

<div align="center">

**CRVA - 下一代隐私保护多签钱包**

Made with ❤️ for Web3

</div>
