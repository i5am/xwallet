# WDK 协议功能使用指南

## 概述

WDK 钱包现在已经完全实现了标准化的通信协议,用于热钱包与冷钱包之间的安全交互。所有的发送、接收、签名等操作都会生成符合 WDK 协议标准的二维码。

## 功能特性

### ✅ 已实现的功能

1. **发送交易** - 生成符合协议的交易签名请求二维码
2. **接收地址** - 生成包含地址信息的协议二维码
3. **消息签名** - 支持扫描协议格式的消息签名请求
4. **交易签名** - 支持扫描协议格式的交易签名请求
5. **授权请求** - 支持扫描协议格式的DApp授权请求
6. **签名响应** - 所有签名操作都会生成符合协议的响应二维码

### 🔄 协议格式

所有消息采用统一的 JSON 格式：

```json
{
  "protocol": "WDK",
  "version": "1.0.0",
  "type": "消息类型",
  "timestamp": 时间戳,
  "data": { 具体数据 }
}
```

## 使用流程

### 1. 发送交易 (热钱包 → 冷钱包)

**热钱包操作：**

1. 选择钱包,点击 "发送" 按钮
2. 填写接收地址、金额、手续费、备注
3. 点击 "生成签名请求"
4. 系统生成 `SIGN_TRANSACTION_REQUEST` 协议二维码

**冷钱包操作：**

1. 点击 "扫描" 按钮
2. 扫描热钱包生成的交易请求二维码
3. 确认交易详情（收款地址、金额、手续费）
4. 点击 "确认签名"
5. 系统生成 `SIGN_TRANSACTION_RESPONSE` 签名响应二维码

**热钱包操作：**

1. 扫描冷钱包生成的签名响应二维码
2. 系统自动提取签名结果
3. 广播交易到区块链网络

---

### 2. 接收地址 (分享给他人)

1. 选择钱包,点击 "接收" 按钮
2. 系统自动生成 `ADDRESS_INFO` 协议二维码
3. 二维码包含：
   - 链类型 (BTC/ETH/BNB)
   - 网络 (mainnet/testnet)
   - 钱包地址
   - 公钥（如有）
   - 地址标签

---

### 3. 消息签名 (DApp → 冷钱包)

**使用测试工具生成请求：**

1. 打开 `tools/protocol-qr-generator.html`
2. 切换到 "消息签名" 标签
3. 填写签名地址和消息内容
4. 生成 `SIGN_MESSAGE_REQUEST` 二维码

**冷钱包签名：**

1. 使用冷钱包扫描消息签名请求
2. 查看消息内容和请求者信息
3. 确认无误后点击 "确认签名"
4. 生成 `SIGN_MESSAGE_RESPONSE` 签名响应

---

### 4. DApp 授权

**生成授权请求：**

1. 使用测试工具生成授权请求二维码
2. 指定 DApp 名称、网址、权限列表

**冷钱包授权：**

1. 扫描授权请求二维码
2. 查看授权详情（域名、权限、有效期）
3. 确认后生成授权响应

---

## 协议消息类型

### 请求类型

| 类型 | 说明 | 发起方 |
|-----|------|--------|
| `SIGN_TRANSACTION_REQUEST` | 交易签名请求 | 热钱包 |
| `SIGN_MESSAGE_REQUEST` | 消息签名请求 | 热钱包/DApp |
| `AUTHORIZATION_REQUEST` | 授权请求 | DApp |
| `ADDRESS_INFO` | 地址信息 | 钱包 |

### 响应类型

| 类型 | 说明 | 发起方 |
|-----|------|--------|
| `SIGN_TRANSACTION_RESPONSE` | 交易签名响应 | 冷钱包 |
| `SIGN_MESSAGE_RESPONSE` | 消息签名响应 | 冷钱包 |
| `AUTHORIZATION_RESPONSE` | 授权响应 | 冷钱包 |

---

## 测试工具

### 协议二维码生成器

**位置：** `tools/protocol-qr-generator.html`

**功能：**
- 生成转账交易请求二维码
- 生成消息签名请求二维码
- 生成授权请求二维码
- 生成地址信息二维码

**使用方法：**

1. 在浏览器中打开文件
2. 选择需要的消息类型标签
3. 填写相关参数
4. 点击生成按钮
5. 扫描生成的二维码进行测试

---

## 安全验证

程序会自动进行以下安全检查：

### 1. 协议验证
- ✅ 协议名称必须为 `WDK`
- ✅ 协议版本必须兼容 (主版本匹配)
- ✅ 时间戳在有效范围内 (±5分钟)

### 2. 链类型匹配
- ✅ 交易请求的链类型必须与钱包链类型一致
- ✅ 消息签名的链类型必须与钱包链类型一致

### 3. 地址验证
- ✅ 交易发送地址必须与当前钱包地址匹配
- ✅ 地址格式必须正确

### 4. 钱包类型检查
- ✅ 观测钱包不能执行签名操作
- ✅ 必须有私钥才能签名

---

## 常见问题

### Q1: 扫描后显示 "协议消息验证失败"

**原因：**
- 二维码不是 WDK 协议格式
- 协议版本不兼容
- 时间戳过期（超过5分钟）

**解决方法：**
- 使用 `protocol-qr-generator.html` 生成标准格式二维码
- 检查系统时间是否正确
- 重新生成新的二维码

---

### Q2: 链类型不匹配错误

**原因：**
- 使用 BTC 钱包扫描了 ETH 交易请求
- 请求中的 chain 字段与钱包不符

**解决方法：**
- 确保使用正确的钱包扫描对应链的请求
- 在生成二维码时选择正确的链类型

---

### Q3: 地址不匹配错误

**原因：**
- 交易请求中的 from 地址与当前钱包地址不符

**解决方法：**
- 使用正确的钱包扫描
- 检查交易请求中的发送方地址

---

### Q4: 观测钱包无法签名

**原因：**
- 观测钱包只能查看，不能执行签名操作

**解决方法：**
- 使用热钱包或冷钱包进行签名
- 将观测钱包切换为热钱包（需要导入私钥）

---

## 完整使用示例

### 场景：冷钱包转账 BTC

**第一步：创建交易请求（热钱包）**

1. 打开热钱包应用
2. 选择 BTC 热钱包
3. 点击 "发送" 按钮
4. 填写信息：
   - 接收地址: `bc1qar0srrr7xfkvy5l643lydnw9re59gtzzwf5mdq`
   - 金额: `0.001`
   - 手续费: `0.00001`
   - 备注: `测试转账`
5. 点击 "生成签名请求"
6. 屏幕显示交易请求二维码

**第二步：签名交易（冷钱包）**

1. 打开冷钱包设备（离线设备）
2. 选择对应的 BTC 冷钱包
3. 点击 "扫描" 按钮
4. 扫描热钱包显示的二维码
5. 确认交易信息：
   - ✅ 收款地址正确
   - ✅ 金额正确
   - ✅ 手续费合理
6. 点击 "确认签名"
7. 屏幕显示签名响应二维码

**第三步：广播交易（热钱包）**

1. 回到热钱包应用
2. 点击 "扫描" 按钮
3. 扫描冷钱包生成的签名响应二维码
4. 系统自动提取签名
5. 广播交易到 BTC 网络
6. 显示交易哈希

---

## 技术实现

### 协议工具类

**位置：** `src/utils/protocol.ts`

**主要功能：**
- `createTransactionRequest()` - 创建交易请求
- `createTransactionResponse()` - 创建交易响应
- `createMessageSignRequest()` - 创建消息签名请求
- `createMessageSignResponse()` - 创建消息签名响应
- `createAuthorizationRequest()` - 创建授权请求
- `createAuthorizationResponse()` - 创建授权响应
- `createAddressInfo()` - 创建地址信息
- `parseMessage()` - 解析协议消息
- `validateMessage()` - 验证协议消息
- `serializeMessage()` - 序列化消息为 JSON

### 代码示例

```typescript
import { ProtocolUtils } from './utils/protocol';

// 创建交易请求
const txRequest = ProtocolUtils.createTransactionRequest({
  from: 'bc1p...',
  to: 'bc1q...',
  amount: '0.001',
  fee: '0.00001',
  chain: ChainType.BTC,
  network: NetworkType.MAINNET,
  memo: '测试转账',
});

// 生成二维码
const qrData = ProtocolUtils.serializeMessage(txRequest);
QRCode.toDataURL(qrData, { width: 300 });
```

---

## 协议文档

完整的协议规范请参考：
- **中文文档：** `docs/protocol.md`
- **测试工具：** `tools/protocol-qr-generator.html`

---

## 更新日志

### v1.0.0 (2025-10-20)

**新增：**
- ✅ 实现 WDK 通信协议标准
- ✅ 发送功能生成协议格式交易请求
- ✅ 接收功能生成协议格式地址信息
- ✅ 扫描功能支持协议消息识别
- ✅ 签名功能生成协议格式响应
- ✅ 协议消息验证和安全检查
- ✅ 协议工具类 (ProtocolUtils)
- ✅ 协议二维码生成器工具
- ✅ 完整的协议文档

**改进：**
- ✅ 统一所有二维码格式
- ✅ 增强安全验证机制
- ✅ 优化用户交互流程
- ✅ 兼容旧版本数据格式

---

## 下一步计划

### 短期计划
- [ ] 实现真实的签名算法（目前为演示版）
- [ ] 添加 PSBT 支持（Bitcoin）
- [ ] 实现交易广播功能
- [ ] 添加签名历史记录

### 长期计划
- [ ] 多重签名支持
- [ ] 硬件钱包集成
- [ ] NFC 传输支持
- [ ] 蓝牙传输支持

---

## 技术支持

如有问题或建议，请参考：
- 协议规范：`docs/protocol.md`
- 代码文档：`src/utils/protocol.ts`
- 测试工具：`tools/protocol-qr-generator.html`

---

**最后更新：** 2025-10-20  
**协议版本：** 1.0.0  
**维护者：** WDK Development Team
