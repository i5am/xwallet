# 离线交易流程说明

## 问题分析

### 问题 1: 扫描二维码没有填充到文本框 ❌

**根本原因**: `scanInputCallback` 的设置方式有问题

```typescript
// ❌ 错误的方式
setScanInputCallback(() => callback);

// 这会导致 React 认为 callback 是一个函数，而不是要保存的值
```

**解决方案**: 需要双层箭头函数

```typescript
// ✅ 正确的方式
setScanInputCallback(() => (value: string) => callback(value));
```

### 问题 2: 接收 BTC/ETH 二维码没有显示 ❌

**根本原因**: 代码被临时禁用了

```typescript
// 当前代码 (第 90-96 行)
useEffect(() => {
  // 临时禁用 QR 码生成以测试稳定性
  if (showReceiveDialog && selectedWallet) {
    // 生成占位符 QR 码
    setQrCodeDataUrl('data:image/svg+xml;base64,...'); // 显示"QR 代码占位符"
  }
}, [showReceiveDialog, selectedWallet, useProtocolFormat]);
```

**解决方案**: 恢复二维码生成功能

---

## 离线交易完整流程

### 🔥 热钱包（在线）<-> ❄️ 冷钱包（离线）交互流程

```
┌─────────────────────────────────────────────────────────────────┐
│                       离线交易完整流程                           │
└─────────────────────────────────────────────────────────────────┘

设备 A: 热钱包 (联网手机/电脑)    设备 B: 冷钱包 (离线手机/电脑)
     [在线]                              [离线]

═══════════════════════════════════════════════════════════════════
第一步: 准备交易（热钱包）
═══════════════════════════════════════════════════════════════════

📱 设备 A (在线)
  ↓
1. 打开热钱包/观察钱包
  ↓
2. 点击"发送" → 填写:
   • 接收地址: bc1p...
   • 金额: 0.01 BTC
   • 手续费: 10 sat/vB
  ↓
3. 点击"生成未签名交易"
  ↓
4. 显示二维码:
   ┌─────────────────────┐
   │  █████████████████  │
   │  ██ ▄▄▄▄▄ ██▀ ██   │   协议格式:
   │  ██ █   █ ██▄ ██   │   {
   │  ██ █▄▄▄█ █▄▀ ██   │     "type": "UNSIGNED_TX",
   │  ██ ▄▄▄▄▄ ███ ██   │     "data": {
   │  ██▄█ ▀ █▄█  ▄██   │       "from": "bc1p...",
   │  █████████████████  │       "to": "bc1q...",
   │                     │       "amount": "0.01",
   │  未签名交易          │       "fee": "0.0001",
   └─────────────────────┘       "rawTx": "010000..."
                                }
                              }

═══════════════════════════════════════════════════════════════════
第二步: 签名交易（冷钱包）
═══════════════════════════════════════════════════════════════════

📱 设备 B (离线)
  ↓
1. 打开冷钱包
  ↓
2. 点击"签名" → "扫描未签名交易"
  ↓
3. 摄像头扫描设备 A 的二维码
  ↓
4. 自动解析交易信息，显示确认界面:
   ┌─────────────────────────────┐
   │ 🔒 确认签名交易              │
   ├─────────────────────────────┤
   │ 发送地址: bc1p... (本钱包)  │
   │ 接收地址: bc1q...           │
   │ 金额: 0.01 BTC              │
   │ 手续费: 0.0001 BTC          │
   │ 总计: 0.0101 BTC            │
   ├─────────────────────────────┤
   │ ⚠️ 请确认交易信息无误        │
   │                             │
   │   [取消]        [确认签名]  │
   └─────────────────────────────┘
  ↓
5. 点击"确认签名"
  ↓
6. 使用冷钱包私钥签名
  ↓
7. 显示已签名交易二维码:
   ┌─────────────────────┐
   │  █████████████████  │
   │  ██ ▄▄▄▄▄ ██ ▄ ██  │   协议格式:
   │  ██ █   █ █▀▀ ▄██  │   {
   │  ██ █▄▄▄█ █ ▄█ ██  │     "type": "SIGNED_TX",
   │  ██ ▄▄▄▄▄ █▀ █ ██  │     "data": {
   │  ███▄█▄ ▀▄█▄ ▄███  │       "signedTx": "0100000...",
   │  █████████████████  │       "txid": "abc123..."
   │                     │     }
   │  已签名交易          │   }
   └─────────────────────┘

═══════════════════════════════════════════════════════════════════
第三步: 广播交易（热钱包）
═══════════════════════════════════════════════════════════════════

📱 设备 A (在线)
  ↓
1. 点击"广播" → "扫描已签名交易"
  ↓
2. 摄像头扫描设备 B 的二维码
  ↓
3. 自动解析已签名交易
  ↓
4. 通过网络广播到区块链:
   ┌─────────────────────────────┐
   │ 📡 正在广播交易...           │
   │                             │
   │ [████████████░░░░] 75%      │
   └─────────────────────────────┘
  ↓
5. 交易广播成功:
   ┌─────────────────────────────┐
   │ ✅ 交易已提交                │
   ├─────────────────────────────┤
   │ 交易 ID: abc123...          │
   │ 状态: 待确认                │
   │                             │
   │ 预计确认时间: 10-20 分钟    │
   │                             │
   │   [查看详情]      [完成]    │
   └─────────────────────────────┘
  ↓
6. 完成! 🎉
```

---

## 接收流程

### 场景 1: 热钱包接收（在线）

```
📱 设备 A (热钱包 - 在线)
  ↓
1. 打开钱包 → 点击"接收"
  ↓
2. 显示接收地址二维码:
   ┌─────────────────────┐
   │  █████████████████  │
   │  ██ ▄▄▄▄▄ █▄ █ ██  │   简单格式:
   │  ██ █   █ █▀▄▀ ██  │   bc1pjpv78z8r0xkz7...
   │  ██ █▄▄▄█ █ ▄  ██  │
   │  ██ ▄▄▄▄▄ ▀█▄█ ██  │   协议格式:
   │  ██ ▄ ▀▄▀▄▀  ▄ ██  │   {
   │  █████████████████  │     "type": "ADDRESS_INFO",
   │                     │     "data": {
   │  bc1pjpv...         │       "address": "bc1p...",
   └─────────────────────┘       "chain": "BTC",
   ↓                             "network": "mainnet"
   ↓ [切换协议格式]              }
   ↓                           }
   ┌─────────────────────┐
   │  bc1pjpv78z8r0xkz7  │
   │  s3h9m4e5qlqe3e6h2  │   显示完整地址
   │  rr3nzy9ls99jnxy47  │   (可复制)
   │  lzs9kn3              │
   │                     │
   │  [📋 复制地址]       │
   └─────────────────────┘
  ↓
3. 发送方扫描二维码
  ↓
4. 发送方发起转账
  ↓
5. 热钱包自动检测到新交易:
   ┌─────────────────────────────┐
   │ 🔔 收到新交易!               │
   ├─────────────────────────────┤
   │ 金额: +0.01 BTC             │
   │ 发送方: bc1q...             │
   │ 状态: 待确认 (0/6)          │
   │ 交易 ID: xyz789...          │
   │                             │
   │   [查看详情]      [关闭]    │
   └─────────────────────────────┘
  ↓
6. 等待区块确认 (约 10-60 分钟)
  ↓
7. 余额更新! ✅
```

### 场景 2: 冷钱包接收（离线）

```
📱 设备 B (冷钱包 - 离线)
  ↓
1. 打开钱包 → 点击"接收"
  ↓
2. 显示接收地址二维码:
   ┌─────────────────────┐
   │  █████████████████  │
   │  ██ ▄▄▄▄▄ █▄ █ ██  │
   │  ██ █   █ █▀▄▀ ██  │
   │  ██ █▄▄▄█ █ ▄  ██  │   bc1p... (冷钱包地址)
   │  ██ ▄▄▄▄▄ ▀█▄█ ██  │
   │  ██ ▄ ▀▄▀▄▀  ▄ ██  │
   │  █████████████████  │
   │                     │
   │  冷钱包地址          │
   └─────────────────────┘
  ↓
3. 发送方扫描二维码 → 发起转账
  ↓
4. ⚠️ 冷钱包无法自动检测交易 (离线)
  ↓
5. 手动查询方式:
   
   方式 A: 使用观察钱包 (推荐)
   ┌─────────────────────────────┐
   │ 📱 另一台在线设备             │
   ├─────────────────────────────┤
   │ 1. 导入冷钱包地址为"观察钱包"│
   │    (只需要地址，不需要私钥)  │
   │                             │
   │ 2. 观察钱包自动同步余额和交易│
   │                             │
   │ 3. 查看交易历史和确认状态    │
   └─────────────────────────────┘
   
   方式 B: 手动在区块浏览器查询
   ┌─────────────────────────────┐
   │ 🌐 区块浏览器                │
   ├─────────────────────────────┤
   │ • Bitcoin: blockchain.com   │
   │ • Ethereum: etherscan.io    │
   │                             │
   │ 输入冷钱包地址 → 查看交易    │
   └─────────────────────────────┘
```

---

## 二维码数据格式

### 1. 地址二维码（接收）

**简单格式** (默认):
```
bc1pjpv78z8r0xkz7s3h9m4e5qlqe3e6h2rr3nzy9ls99jnxy47lzs9kn3
```

**协议格式** (WDK Protocol):
```json
{
  "version": "1.0",
  "type": "ADDRESS_INFO",
  "timestamp": 1730073600,
  "data": {
    "address": "bc1pjpv78z8r0xkz7s3h9m4e5qlqe3e6h2rr3nzy9ls99jnxy47lzs9kn3",
    "chain": "BTC",
    "network": "mainnet",
    "walletType": "cold",
    "publicKey": "02abc..."
  }
}
```

### 2. 未签名交易二维码

```json
{
  "version": "1.0",
  "type": "UNSIGNED_TX",
  "timestamp": 1730073600,
  "data": {
    "chain": "BTC",
    "network": "mainnet",
    "from": "bc1p...",
    "to": "bc1q...",
    "amount": "0.01",
    "fee": "0.0001",
    "rawTx": "0100000001abc...",
    "inputs": [...],
    "outputs": [...]
  }
}
```

### 3. 已签名交易二维码

```json
{
  "version": "1.0",
  "type": "SIGNED_TX",
  "timestamp": 1730073600,
  "data": {
    "chain": "BTC",
    "network": "mainnet",
    "signedTx": "0100000001abc...def",
    "txid": "xyz789...",
    "from": "bc1p...",
    "to": "bc1q...",
    "amount": "0.01",
    "fee": "0.0001"
  }
}
```

---

## 安全最佳实践

### 冷钱包安全 ❄️

1. **设备要求**:
   - ✅ 永久断网的设备（手机/电脑）
   - ✅ 移除 SIM 卡
   - ✅ 禁用 WiFi、蓝牙
   - ✅ 物理隔离

2. **使用原则**:
   - ✅ 只用于签名交易
   - ✅ 私钥永不联网
   - ✅ 定期备份助记词（纸质）
   - ❌ 不截图、不拍照私钥

3. **交互方式**:
   - ✅ 二维码扫描（推荐）
   - ✅ USB 离线传输
   - ❌ 不通过网络传输

### 热钱包安全 🔥

1. **设备要求**:
   - ✅ 常用设备（手机/电脑）
   - ✅ 保持系统更新
   - ✅ 安装杀毒软件

2. **使用原则**:
   - ✅ 设置强密码
   - ✅ 定期更换密码
   - ✅ 备份助记词
   - ✅ 小额资金

3. **风险提示**:
   - ⚠️ 联网设备有被黑风险
   - ⚠️ 大额资金建议用冷钱包
   - ⚠️ 不在公共 WiFi 下使用

---

## 常见问题

### Q1: 冷钱包如何知道收到了转账？

**A**: 冷钱包无法自动检测。有两种方式查询:

1. **观察钱包** (推荐):
   - 在另一台在线设备上，导入冷钱包地址为"观察钱包"
   - 只需要地址，不需要私钥
   - 可以查看余额和交易历史

2. **区块浏览器**:
   - Bitcoin: https://blockchain.com
   - Ethereum: https://etherscan.io
   - 输入冷钱包地址查询

### Q2: 扫描二维码时提示"无法识别"怎么办？

**A**: 检查以下几点:

1. ✅ 二维码清晰可见
2. ✅ 光线充足
3. ✅ 距离适中（10-30cm）
4. ✅ 摄像头权限已授予
5. ✅ 使用后置摄像头

### Q3: 热钱包和冷钱包可以互相转账吗？

**A**: 可以! 完全兼容:

- **热 → 冷**: 直接转账（扫描冷钱包地址）
- **冷 → 热**: 
  1. 热钱包生成未签名交易
  2. 冷钱包扫描并签名
  3. 热钱包扫描签名后广播

### Q4: 观察钱包和冷钱包有什么区别？

**A**:

| 类型 | 联网 | 私钥 | 功能 |
|------|------|------|------|
| 热钱包 🔥 | ✅ 在线 | ✅ 有私钥 | 全功能 (发送/接收) |
| 冷钱包 ❄️ | ❌ 离线 | ✅ 有私钥 | 只能签名 (不能广播) |
| 观察钱包 👁️ | ✅ 在线 | ❌ 无私钥 | 只能查看 (不能发送) |

**典型组合**:
```
冷钱包 (离线, 存大额)
    ↕ (二维码)
观察钱包 (在线, 查余额)
```

### Q5: 如果冷钱包设备坏了怎么办？

**A**: 只要有助记词，资金就是安全的:

1. ✅ 在新设备上恢复钱包
2. ✅ 输入助记词（12 或 24 个单词）
3. ✅ 重新创建为冷钱包
4. ✅ 地址和私钥完全相同

**重要提醒**:
- ⚠️ 务必纸质备份助记词
- ⚠️ 保存在安全的地方（保险箱）
- ⚠️ 不要电子化存储
- ⚠️ 可以多地点备份

---

## 开发待办事项

### 高优先级 🔥

1. **修复扫描填充问题**:
   ```typescript
   // 修改 scanInputCallback 的设置方式
   setScanInputCallback(() => (value: string) => callback(value));
   ```

2. **恢复二维码生成**:
   ```typescript
   // 恢复接收地址二维码的生成逻辑
   useEffect(() => {
     if (showReceiveDialog && selectedWallet) {
       generateReceiveQRCode();
     }
   }, [showReceiveDialog, selectedWallet, useProtocolFormat]);
   ```

3. **实现未签名交易生成**:
   - [ ] 在发送对话框添加"生成未签名交易"按钮
   - [ ] 生成未签名交易二维码
   - [ ] 支持冷钱包扫描

4. **实现签名功能**:
   - [ ] 冷钱包扫描未签名交易
   - [ ] 显示交易确认界面
   - [ ] 使用私钥签名
   - [ ] 生成已签名交易二维码

5. **实现广播功能**:
   - [ ] 热钱包扫描已签名交易
   - [ ] 解析并广播到区块链
   - [ ] 显示交易状态

### 中优先级 ⚡

6. **观察钱包功能**:
   - [ ] 导入地址（不需要私钥）
   - [ ] 查询余额和交易历史
   - [ ] 生成未签名交易

7. **交易历史**:
   - [ ] 显示交易列表
   - [ ] 交易详情
   - [ ] 交易状态跟踪

8. **协议格式优化**:
   - [ ] 支持更多数据类型
   - [ ] 错误处理优化
   - [ ] 兼容性增强

### 低优先级 💡

9. **UI 优化**:
   - [ ] 扫描动画优化
   - [ ] 二维码样式美化
   - [ ] 响应式布局调整

10. **文档完善**:
    - [ ] 用户操作视频教程
    - [ ] 常见问题补充
    - [ ] 安全指南更新

---

## 总结

XWallet 的离线交易功能通过二维码实现了冷热钱包之间的安全交互:

✅ **优点**:
- 冷钱包私钥永不联网（最高安全性）
- 二维码传输简单方便
- 支持协议格式和简单格式
- 完整的发送/接收流程

🔧 **待修复**:
1. 扫描填充功能
2. 接收二维码生成
3. 未签名交易流程
4. 签名和广播功能

📚 **参考文档**:
- `docs/PASSWORD_FEATURE.md` - 密码功能
- `docs/QR_SCAN_INPUT_FEATURE.md` - 二维码扫描
- `docs/FEATURE_SUMMARY.md` - 功能总结

---

*XWallet v1.0.0*  
*更新时间: 2025-10-28*  
© 2024 XWallet Team
