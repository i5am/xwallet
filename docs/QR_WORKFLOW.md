# 二维码扫描工作流程

本文档展示了二维码扫描功能的完整工作流程。

## 总体流程图

```
┌─────────────────────────────────────────────────────────────────┐
│                    冷钱包气隙交易流程                              │
└─────────────────────────────────────────────────────────────────┘

┌──────────────────┐                           ┌──────────────────┐
│   在线钱包       │                           │    离线钱包      │
│   (热钱包)       │                           │   (冷钱包)       │
└──────────────────┘                           └──────────────────┘
        │                                               │
        │  1. 创建交易                                  │
        │     - 输入收款地址                            │
        │     - 输入转账金额                            │
        │     - 构建交易数据                            │
        │                                               │
        ▼                                               │
┌──────────────────┐                                    │
│  生成交易二维码  │                                    │
│  {                │                                    │
│    to: "bc1p..." │                                    │
│    amount: "0.1" │                                    │
│    chain: "BTC"  │                                    │
│  }                │                                    │
└──────────────────┘                                    │
        │                                               │
        │  2. 显示二维码                                │
        │                                               │
        │                    3. 扫描二维码              │
        │  ════════════════════════════════════════>   │
        │                                               │
        │                                               ▼
        │                                    ┌──────────────────┐
        │                                    │  解析交易数据    │
        │                                    │  - 显示收款地址  │
        │                                    │  - 显示转账金额  │
        │                                    │  - 显示链类型    │
        │                                    └──────────────────┘
        │                                               │
        │                                               │ 4. 用户确认
        │                                               │
        │                                               ▼
        │                                    ┌──────────────────┐
        │                                    │  使用私钥签名    │
        │                                    │  - 读取冷钱包    │
        │                                    │  - 执行签名      │
        │                                    │  - 生成签名数据  │
        │                                    └──────────────────┘
        │                                               │
        │                                               │
        │                                               ▼
        │                                    ┌──────────────────┐
        │                                    │ 生成签名二维码   │
        │                                    │ {                │
        │                                    │   signature: ... │
        │                                    │   txData: ...    │
        │                                    │ }                │
        │                                    └──────────────────┘
        │                                               │
        │                                               │ 5. 显示签名二维码
        │  6. 扫描签名二维码                           │
        │  <════════════════════════════════════════   │
        ▼                                               │
┌──────────────────┐                                    │
│  验证签名结果    │                                    │
│  - 解析签名数据  │                                    │
│  - 验证签名有效  │                                    │
│  - 构建完整交易  │                                    │
└──────────────────┘                                    │
        │                                               │
        │  7. 广播交易                                  │
        │                                               │
        ▼                                               │
┌──────────────────┐                                    │
│  发送到区块链    │                                    │
│  - 提交到节点    │                                    │
│  - 等待确认      │                                    │
└──────────────────┘                                    │
        │                                               │
        │  8. 交易完成 ✅                               │
        │                                               │
```

## 消息签名流程

```
┌──────────────────┐                           ┌──────────────────┐
│   请求方         │                           │    签名方        │
│   (网站/应用)    │                           │   (钱包)         │
└──────────────────┘                           └──────────────────┘
        │                                               │
        │  1. 生成签名请求                              │
        │     - 消息内容                                │
        │     - 时间戳                                  │
        │     - 请求者地址                              │
        │                                               │
        ▼                                               │
┌──────────────────┐                                    │
│  生成消息二维码  │                                    │
│  {                │                                    │
│    message: "..." │                                    │
│    timestamp: ... │                                    │
│    address: "..." │                                    │
│  }                │                                    │
└──────────────────┘                                    │
        │                                               │
        │  2. 显示二维码                                │
        │                                               │
        │                    3. 扫描二维码              │
        │  ════════════════════════════════════════>   │
        │                                               │
        │                                               ▼
        │                                    ┌──────────────────┐
        │                                    │  显示消息内容    │
        │                                    │  - 消息文本      │
        │                                    │  - 请求者地址    │
        │                                    │  - 时间戳        │
        │                                    └──────────────────┘
        │                                               │
        │                                               │ 4. 用户确认
        │                                               │
        │                                               ▼
        │                                    ┌──────────────────┐
        │                                    │  签名消息        │
        │                                    │  - 使用私钥签名  │
        │                                    │  - 生成签名结果  │
        │                                    └──────────────────┘
        │                                               │
        │                                               │
        │                                               ▼
        │                                    ┌──────────────────┐
        │                                    │ 生成签名二维码   │
        │                                    │ {                │
        │                                    │   message: ...   │
        │                                    │   signature: ... │
        │                                    │   address: ...   │
        │                                    │ }                │
        │                                    └──────────────────┘
        │                                               │
        │                                               │ 5. 显示签名二维码
        │  6. 扫描签名二维码                           │
        │  <════════════════════════════════════════   │
        ▼                                               │
┌──────────────────┐                                    │
│  验证签名        │                                    │
│  - 解析签名数据  │                                    │
│  - 验证签名有效  │                                    │
│  - 确认身份      │                                    │
└──────────────────┘                                    │
        │                                               │
        │  7. 签名验证成功 ✅                           │
        │                                               │
```

## 技术实现细节

### 摄像头访问流程

```
┌─────────────────────────────────────────────────────┐
│                 摄像头访问流程                       │
└─────────────────────────────────────────────────────┘

用户点击"扫描二维码"
        │
        ▼
调用 startScan()
        │
        ▼
navigator.mediaDevices.getUserMedia({
  video: { facingMode: 'environment' }
})
        │
        ├─── 成功 ──────────────┐
        │                       │
        │                       ▼
        │            设置 video.srcObject = stream
        │                       │
        │                       ▼
        │            video.play()
        │                       │
        │                       ▼
        │            启动扫描循环 (每 100ms)
        │                       │
        │                       ▼
        │            scanFrame()
        │              │
        │              ├─ 绘制视频帧到 canvas
        │              ├─ 获取图像数据
        │              └─ jsQR 解析二维码
        │                       │
        │                       ├─── 找到二维码 ─────┐
        │                       │                    │
        │                       │                    ▼
        │                       │         stopScan()
        │                       │                    │
        │                       │                    ▼
        │                       │       handleScanResult(data)
        │                       │                    │
        │                       │                    ▼
        │                       │         解析 JSON 数据
        │                       │                    │
        │                       │                    ├─ 消息签名
        │                       │                    ├─ 交易签名
        │                       │                    └─ 其他数据
        │                       │
        │                       └─── 未找到 ────> 继续扫描
        │
        └─── 失败 ──────────────┐
                                │
                                ▼
                        显示错误信息
                                │
                                ▼
                        setIsScanning(false)
```

### 二维码解析流程

```
┌─────────────────────────────────────────────────────┐
│               二维码数据解析流程                     │
└─────────────────────────────────────────────────────┘

扫描到二维码数据
        │
        ▼
尝试 JSON.parse(data)
        │
        ├─── 解析成功 ──────────┐
        │                       │
        │                       ▼
        │            检查字段类型
        │                       │
        │                       ├─ 包含 "message" ──────> 消息签名请求
        │                       │                          │
        │                       │                          ├─ 显示消息内容
        │                       │                          ├─ 显示请求地址
        │                       │                          └─ 提供签名按钮
        │                       │
        │                       ├─ 包含 "transaction" ───> 交易签名请求
        │                       │    或 "to"               │
        │                       │                          ├─ 显示收款地址
        │                       │                          ├─ 显示转账金额
        │                       │                          ├─ 显示链类型
        │                       │                          └─ 提供签名按钮
        │                       │
        │                       └─ 其他 JSON ────────────> 显示原始数据
        │
        └─── 解析失败 ──────────┐
                                │
                                ▼
                        非 JSON 数据
                                │
                                ├─ 可能是地址
                                ├─ 可能是文本
                                └─ 显示原始内容
```

### 签名生成流程

```
┌─────────────────────────────────────────────────────┐
│                  签名生成流程                        │
└─────────────────────────────────────────────────────┘

用户点击"签名"按钮
        │
        ▼
验证钱包状态
        │
        ├─ 观测钱包 ──────────> 提示错误（无法签名）
        ├─ 无私钥 ────────────> 提示错误（缺少私钥）
        └─ 正常 ──────────────┐
                              │
                              ▼
                根据链类型选择签名方式
                              │
                              ├─ BTC ──────────┐
                              │                │
                              │                ▼
                              │     使用 BTC 私钥签名
                              │     (简化演示版本)
                              │                │
                              │                └─────────┐
                              │                          │
                              ├─ ETH ──────────┐         │
                              │                │         │
                              │                ▼         │
                              │     使用 ETH 私钥签名    │
                              │     (简化演示版本)       │
                              │                │         │
                              │                └─────────┤
                              │                          │
                              └──────────────────────────┤
                                                         │
                                                         ▼
                                            构建签名数据对象
                                            {
                                              message/transaction: ...,
                                              signature: ...,
                                              address: ...,
                                              chain: ...,
                                              timestamp: ...
                                            }
                                                         │
                                                         ▼
                                            QRCode.toDataURL(JSON.stringify(data))
                                                         │
                                                         ▼
                                            显示签名结果二维码
                                                         │
                                                         ▼
                                            提示用户扫描并广播
```

## 安全考虑

### 冷钱包安全隔离

```
┌─────────────────────────────────────────────────────┐
│               冷钱包安全模型                         │
└─────────────────────────────────────────────────────┘

┌──────────────────────────────────────────┐
│          物理隔离环境                     │
│  ┌────────────────────────────────┐     │
│  │      离线设备 (冷钱包)          │     │
│  │                                 │     │
│  │  ✅ 私钥存储                   │     │
│  │  ✅ 离线签名                   │     │
│  │  ✅ 二维码扫描                 │     │
│  │  ✅ 签名二维码生成             │     │
│  │                                 │     │
│  │  ❌ 无网络连接                 │     │
│  │  ❌ 无蓝牙/WiFi                │     │
│  │  ❌ 无 USB 数据传输             │     │
│  │                                 │     │
│  └────────────────────────────────┘     │
│                                          │
│         ↕ (仅通过二维码)                 │
│                                          │
└──────────────────────────────────────────┘
                  │
                  │ 二维码
                  │
┌──────────────────────────────────────────┐
│          在线环境                         │
│  ┌────────────────────────────────┐     │
│  │      在线设备 (热钱包)          │     │
│  │                                 │     │
│  │  ✅ 创建交易                   │     │
│  │  ✅ 广播交易                   │     │
│  │  ✅ 二维码生成                 │     │
│  │  ✅ 签名验证                   │     │
│  │                                 │     │
│  │  ❌ 无私钥存储                 │     │
│  │  ❌ 无离线签名                 │     │
│  │                                 │     │
│  └────────────────────────────────┘     │
│                                          │
│         ↕ (网络连接)                     │
│                                          │
│  ┌────────────────────────────────┐     │
│  │       区块链网络                │     │
│  │  - 接收已签名交易              │     │
│  │  - 验证并确认                  │     │
│  │  - 更新状态                    │     │
│  └────────────────────────────────┘     │
│                                          │
└──────────────────────────────────────────┘
```

### 数据流安全性

```
数据类型              传输方式         安全特性
────────────────────────────────────────────────
交易请求数据          二维码           ✅ 只读，可公开
消息签名请求          二维码           ✅ 只读，可公开
签名结果              二维码           ✅ 只读，可验证
私钥                  永不传输         ✅ 永远保持隔离
助记词                永不传输         ✅ 永远保持隔离
```

## 最佳实践

### 冷钱包使用建议

1. **设备隔离**
   - 使用专门的离线设备作为冷钱包
   - 永不连接网络
   - 禁用所有无线功能

2. **环境安全**
   - 在私密环境中进行签名操作
   - 注意摄像头隐私
   - 避免被他人看到二维码

3. **验证流程**
   - 仔细检查交易详情
   - 确认收款地址和金额
   - 验证签名结果

4. **备份策略**
   - 多地备份助记词
   - 使用金属板记录
   - 定期验证备份有效性

### 热钱包使用建议

1. **金额控制**
   - 只存储小额资金
   - 定期转移到冷钱包
   - 设置自动转账阈值

2. **设备安全**
   - 使用可信设备
   - 保持系统更新
   - 安装安全软件

3. **操作习惯**
   - 不在公共场所操作
   - 注意网络安全
   - 定期检查交易记录

## 参考资源

- [二维码扫描功能文档](QR_SCANNING_FEATURE.md)
- [二维码测试示例](QR_CODE_EXAMPLES.md)
- [快速开始指南](../GETTING_STARTED.md)
- [开发文档](../DEVELOPMENT.md)
