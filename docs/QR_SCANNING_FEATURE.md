# 二维码扫描功能文档

## 概述

本钱包应用已集成二维码扫描功能，用于实现冷钱包的气隙交易场景。通过扫描二维码，钱包可以识别需要签名的消息和交易，完成安全的离线签名流程。

## 功能特性

### 1. 自动识别二维码类型

扫描功能可以自动识别以下类型的二维码：

- **消息签名请求**：包含 `message` 字段的 JSON 数据
- **交易签名请求**：包含 `transaction` 或 `to` 字段的 JSON 数据
- **原始数据**：非 JSON 格式的纯文本数据（如钱包地址）

### 2. 实时摄像头扫描

- 使用浏览器的 `navigator.mediaDevices.getUserMedia` API 访问摄像头
- 优先使用后置摄像头（移动设备）
- 每 100ms 扫描一次视频帧，实现实时识别
- 扫描成功后自动停止摄像头

### 3. 签名流程

#### 消息签名
1. 扫描包含消息的二维码
2. 显示消息内容和请求地址
3. 用户确认后点击"签名此消息"
4. 生成签名结果二维码
5. 在线钱包扫描签名二维码进行验证

#### 交易签名
1. 扫描包含交易信息的二维码
2. 显示交易详情（收款地址、金额、链类型）
3. 用户确认后点击"签名此交易"
4. 生成签名交易二维码
5. 在线钱包扫描签名二维码广播交易

## 使用场景

### 冷钱包气隙交易流程

1. **在线钱包（热钱包）**：
   - 创建交易
   - 生成交易信息二维码

2. **离线钱包（冷钱包）**：
   - 点击"扫描二维码"按钮
   - 扫描交易二维码
   - 查看交易详情
   - 使用冷钱包私钥签名
   - 生成签名结果二维码

3. **在线钱包（热钱包）**：
   - 扫描签名结果二维码
   - 广播已签名交易到区块链网络

### 消息签名场景

- 身份验证
- 授权登录
- 数据证明
- 合约交互确认

## 技术实现

### 核心依赖

```json
{
  "jsqr": "^1.4.0",      // 二维码解析库
  "qrcode": "^1.5.4"     // 二维码生成库
}
```

### 关键组件

#### 1. 状态管理

```typescript
const [showScanDialog, setShowScanDialog] = useState(false);
const [scanResult, setScanResult] = useState<any>(null);
const [isScanning, setIsScanning] = useState(false);
const videoRef = useRef<HTMLVideoElement>(null);
const canvasRef = useRef<HTMLCanvasElement>(null);
const scanIntervalRef = useRef<number | null>(null);
```

#### 2. 核心函数

- `startScan()`: 启动摄像头并开始扫描循环
- `stopScan()`: 停止扫描并释放摄像头资源
- `scanFrame()`: 扫描单帧视频图像
- `handleScanResult()`: 处理扫描结果并识别数据类型
- `signScannedMessage()`: 签名扫描到的消息
- `signScannedTransaction()`: 签名扫描到的交易

### 数据格式

#### 消息签名请求

```json
{
  "message": "需要签名的消息内容",
  "address": "请求者的钱包地址（可选）",
  "timestamp": 1234567890
}
```

#### 交易签名请求

```json
{
  "to": "0x1234567890abcdef...",
  "amount": "0.1",
  "chain": "ETH",
  "data": "0x...",
  "gasLimit": "21000"
}
```

或

```json
{
  "transaction": {
    "to": "bc1p...",
    "amount": "0.001",
    "chain": "BTC"
  }
}
```

#### 签名结果

```json
{
  "message": "原始消息",
  "signature": "0x1234...",
  "address": "签名者地址",
  "chain": "BTC",
  "timestamp": 1234567890
}
```

## 用户界面

### 扫描对话框

- **摄像头预览区域**：显示实时视频流
- **扫描指示器**：蓝色方框动画，表示正在扫描
- **控制按钮**：
  - 开始扫描：启动摄像头
  - 停止扫描：停止扫描
  - 关闭：关闭对话框

### 扫描结果显示

- **消息签名请求**：
  - 消息内容
  - 请求地址（如有）
  - "签名此消息"按钮

- **交易签名请求**：
  - 收款地址
  - 金额
  - 链类型
  - "签名此交易"按钮

- **签名结果二维码**：
  - 二维码图片
  - 使用说明

## 安全性

### 1. 冷钱包隔离

- 冷钱包始终保持离线状态
- 私钥永不离开冷钱包设备
- 通过二维码传递数据，避免网络暴露

### 2. 用户确认

- 签名前显示完整的交易/消息详情
- 用户必须手动确认才能签名
- 清晰的提示信息

### 3. 数据验证

- 解析 JSON 数据前进行格式验证
- 识别数据类型并显示相应界面
- 错误处理和用户提示

## 浏览器兼容性

### 摄像头 API 支持

- Chrome/Edge: ✅ 完全支持
- Firefox: ✅ 完全支持
- Safari: ✅ 支持（需要 HTTPS）
- 移动浏览器: ✅ 支持

### HTTPS 要求

现代浏览器要求在 HTTPS 环境下才能访问摄像头（本地开发除外）。

## 使用示例

### 1. 启动扫描

```typescript
// 用户点击"扫描二维码"按钮
<button onClick={() => setShowScanDialog(true)}>
  <Camera className="w-5 h-5" />
  扫描二维码
</button>
```

### 2. 扫描二维码

对话框自动启动摄像头并开始扫描。

### 3. 查看结果

扫描成功后显示解析后的数据：
- 消息签名请求 → 显示消息内容
- 交易签名请求 → 显示交易详情
- 其他数据 → 显示原始内容

### 4. 执行签名

点击相应的签名按钮，生成签名结果二维码。

### 5. 继续扫描或关闭

- 点击"继续扫描"重新启动摄像头
- 点击"关闭"退出扫描对话框

## 故障排除

### 摄像头无法启动

**可能原因**：
1. 浏览器未授予摄像头权限
2. 其他应用正在使用摄像头
3. 设备没有摄像头

**解决方案**：
1. 检查浏览器权限设置
2. 关闭其他使用摄像头的应用
3. 使用有摄像头的设备

### 二维码无法识别

**可能原因**：
1. 二维码质量差或模糊
2. 光线不足
3. 二维码数据格式不支持

**解决方案**：
1. 确保二维码清晰完整
2. 在光线充足的环境下扫描
3. 检查二维码数据格式是否正确

### 签名失败

**可能原因**：
1. 钱包类型不支持签名（观测钱包）
2. 钱包缺少私钥
3. 数据格式错误

**解决方案**：
1. 使用热钱包或冷钱包
2. 确保钱包包含私钥
3. 检查扫描的二维码数据格式

## 未来改进

### 计划中的功能

1. **批量签名**：支持扫描多个交易并批量签名
2. **高级签名**：支持 EIP-712 结构化数据签名
3. **二维码优化**：支持分段二维码（大数据量）
4. **签名历史**：记录签名历史并支持导出
5. **多钱包签名**：支持多签钱包的部分签名

### 性能优化

1. 使用 WebWorker 进行二维码解析
2. 优化视频帧采样率
3. 支持不同分辨率的摄像头

## 参考资料

- [jsQR 文档](https://github.com/cozmo/jsqr)
- [QRCode.js 文档](https://github.com/soldair/node-qrcode)
- [MediaDevices API](https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices)
- [BIP-322: Generic Signed Message Format](https://github.com/bitcoin/bips/blob/master/bip-0322.mediawiki)
- [EIP-712: Typed structured data hashing and signing](https://eips.ethereum.org/EIPS/eip-712)
