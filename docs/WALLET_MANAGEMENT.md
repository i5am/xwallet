# 钱包管理功能文档

## 功能概览

本文档描述了钱包管理的核心功能，包括观测钱包转换和钱包删除功能。

## 1. 观测钱包转换功能

### 1.1 功能说明

观测钱包（Watch-Only Wallet）是一种只包含地址、不包含私钥的钱包类型。用户可以通过导入私钥或助记词，将观测钱包转换为热钱包或冷钱包。

### 1.2 使用场景

- **监控钱包余额**：首先创建观测钱包，监控某个地址的余额和交易
- **后续需要签名**：当需要进行签名操作时，导入私钥将观测钱包升级为热钱包或冷钱包
- **安全性考虑**：在不确定环境中先使用观测钱包，确认安全后再导入私钥

### 1.3 操作步骤

#### 步骤1：打开设置
1. 在钱包首页，点击右上角的设置图标（齿轮）
2. 进入设置对话框

#### 步骤2：选择要转换的钱包类型
1. 在"钱包模式"部分，选择：
   - **🔥 热钱包**：在线钱包，支持所有功能
   - **❄️ 冷钱包**：离线钱包，仅签名功能

#### 步骤3：确认转换
1. 系统会提示：
   ```
   ❌ 观测钱包无法直接切换为[热/冷]钱包
   
   观测钱包不包含私钥，需要重新导入私钥才能切换。
   
   是否现在导入私钥？
   ```

2. 点击"确定"继续

#### 步骤4：导入私钥或助记词
1. 系统会显示导入对话框
2. 选择导入方式：
   - **助记词导入**：输入12/24个单词的助记词
   - **私钥导入**：输入私钥字符串

3. 输入完成后点击"导入钱包"

#### 步骤5：地址验证
- 系统会自动验证输入的助记词/私钥生成的地址是否与观测钱包地址一致
- 如果不一致，会提示错误：
  ```
  ❌ 地址不匹配
  
  您输入的助记词/私钥生成的地址与观测钱包的地址不一致。
  
  请确保使用正确的助记词或私钥。
  ```

#### 步骤6：转换完成
- 转换成功后，观测钱包会被替换为热钱包或冷钱包
- 钱包名称会自动更新（例如："BTC 观察钱包" → "BTC 热钱包"）
- 如果转换为热钱包，会自动刷新余额

### 1.4 安全提示

⚠️ **重要安全事项**：

1. **私钥安全**：
   - 助记词和私钥是钱包的最高权限凭证
   - 永远不要在不安全的环境中输入私钥
   - 确保没有人能看到您的屏幕

2. **地址验证**：
   - 转换前请确认地址是否正确
   - 输入错误的助记词/私钥会导致转换失败

3. **备份重要**：
   - 转换前确保已备份助记词或私钥
   - 建议在纸上手写备份，存放在安全的地方

4. **环境安全**：
   - 在安全的网络环境中进行转换
   - 确保设备没有恶意软件
   - 冷钱包建议在离线设备上操作

## 2. 钱包删除功能

### 2.1 功能说明

用户可以删除不需要的钱包，释放钱包列表空间。删除操作是不可逆的，需要谨慎操作。

### 2.2 使用场景

- **清理测试钱包**：删除测试用的钱包
- **移除空钱包**：删除没有余额的钱包
- **整理钱包列表**：保持钱包列表简洁

### 2.3 操作步骤

#### 步骤1：找到要删除的钱包
1. 在钱包首页的钱包列表中，找到要删除的钱包
2. 每个钱包卡片右侧有两个按钮：
   - 🔒 查看详情按钮
   - 🗑️ 删除按钮（红色）

#### 步骤2：点击删除按钮
1. 点击红色的删除按钮（垃圾桶图标）
2. 系统会显示确认对话框：
   ```
   ⚠️ 确认删除钱包？
   
   钱包：BTC 热钱包
   地址：bc1q...xyz
   
   删除后无法恢复！请确保已备份助记词或私钥。
   
   确定要删除吗？
   ```

#### 步骤3：确认删除
1. 仔细检查钱包信息
2. 点击"确定"完成删除
3. 如果点击"取消"，则取消删除操作

#### 步骤4：自动选择新钱包
- 如果删除的是当前选中的钱包，系统会自动选择列表中的第一个钱包
- 钱包列表会立即更新

### 2.4 限制说明

1. **最少保留一个钱包**：
   - 系统至少需要保留一个钱包
   - 如果只有一个钱包，删除操作会被阻止
   - 提示信息：
     ```
     ❌ 无法删除
     
     至少需要保留一个钱包
     ```

2. **删除不可恢复**：
   - 删除操作会立即生效
   - 删除后无法通过系统恢复
   - 只能通过备份的助记词/私钥重新导入

### 2.5 安全提示

⚠️ **删除前必须注意**：

1. **备份确认**：
   - 删除前确保已备份助记词或私钥
   - 建议将备份写在纸上，存放在安全的地方
   - 没有备份的钱包删除后将永久丢失

2. **余额检查**：
   - 确认钱包中没有资产
   - 如果有余额，请先转移到其他钱包
   - 删除后资产将无法找回

3. **交易确认**：
   - 确保没有待处理的交易
   - 删除后将无法查看交易历史

4. **冷静操作**：
   - 删除是不可逆操作，请谨慎操作
   - 不确定时请不要删除
   - 可以先禁用钱包而不是删除

## 3. 技术实现细节

### 3.1 观测钱包转换实现

```typescript
// 转换标记状态
const [isConvertingWatchOnly, setIsConvertingWatchOnly] = useState(false);
const [convertingWalletId, setConvertingWalletId] = useState<string | null>(null);

// 导入钱包时检查是否是转换模式
if (isConvertingWatchOnly && convertingWalletId) {
  // 验证地址是否匹配
  if (address.toLowerCase() !== walletToConvert.address.toLowerCase()) {
    alert('❌ 地址不匹配');
    return;
  }
  
  // 更新钱包类型和私钥
  const updatedWallets = wallets.map(w => 
    w.id === convertingWalletId
      ? {
          ...w,
          type: importWalletType,
          mnemonic,
          privateKey,
          publicKey,
          isOnline: importWalletType === WalletType.HOT,
          updatedAt: Date.now()
        }
      : w
  );
  
  // 保存并更新UI
  setWallets(updatedWallets);
  WalletStorage.saveWallets(updatedWallets);
}
```

### 3.2 钱包删除实现

```typescript
// 删除钱包按钮
<button
  onClick={(e) => {
    e.stopPropagation();
    
    // 检查是否是最后一个钱包
    if (wallets.length <= 1) {
      alert('❌ 无法删除\n\n至少需要保留一个钱包');
      return;
    }
    
    // 确认删除
    if (confirm(`⚠️ 确认删除钱包？\n\n...`)) {
      // 过滤掉要删除的钱包
      const updatedWallets = wallets.filter(w => w.id !== wallet.id);
      setWallets(updatedWallets);
      WalletStorage.saveWallets(updatedWallets);
      
      // 如果删除的是当前钱包，选择第一个
      if (selectedWallet?.id === wallet.id) {
        const newSelected = updatedWallets[0];
        setSelectedWallet(newSelected);
        refreshBalance(newSelected);
      }
      
      alert('✅ 钱包已删除');
    }
  }}
  className="p-2 hover:bg-red-100 dark:hover:bg-red-900/30 rounded transition-colors"
  title="删除钱包"
>
  <Trash2 className="w-4 h-4 text-red-600 dark:text-red-400" />
</button>
```

### 3.3 数据存储

- 钱包数据使用 `WalletStorage.saveWallets()` 持久化存储
- 支持加密存储敏感信息（助记词、私钥）
- 删除操作会立即更新本地存储

## 4. 常见问题 (FAQ)

### Q1: 转换观测钱包时，如何确保使用正确的私钥？

**A**: 系统会自动验证地址。输入助记词或私钥后，系统会生成地址并与观测钱包的地址比对。如果不匹配，会提示错误，转换失败。

### Q2: 删除钱包后还能恢复吗？

**A**: 删除操作是不可逆的。但如果您保存了助记词或私钥，可以通过"导入钱包"功能重新导入。

### Q3: 为什么不能删除最后一个钱包？

**A**: 为了保证应用正常运行，系统要求至少保留一个钱包。如果您想更换钱包，请先导入新钱包，再删除旧钱包。

### Q4: 观测钱包转换为冷钱包后，需要离线吗？

**A**: 建议离线。冷钱包的设计目的是在完全离线的环境中签名交易，以提供最高级别的安全性。转换为冷钱包后，建议关闭设备的网络连接。

### Q5: 可以将热钱包转换为观测钱包吗？

**A**: 可以。在设置中选择"观测钱包"模式，系统会移除私钥信息，将钱包转换为观测钱包。但请注意，转换后将无法进行签名操作。

### Q6: 删除钱包会影响区块链上的资产吗？

**A**: 不会。删除钱包只是从应用中移除钱包信息，不会影响区块链上的资产。只要您保存了助记词或私钥，可以随时重新导入钱包。

## 5. 更新日志

### v1.1.0 (2024-01-XX)

**新增功能**：
- ✅ 观测钱包可以转换为热钱包或冷钱包
- ✅ 钱包列表支持删除钱包
- ✅ 地址验证：确保导入的私钥与观测钱包地址匹配
- ✅ 自动选择：删除当前钱包后自动选择其他钱包
- ✅ 限制保护：至少保留一个钱包，防止误删除

**改进**：
- 优化观测钱包切换流程的用户提示
- 增强删除钱包的确认对话框
- 添加删除按钮的视觉反馈（红色高亮）

**技术细节**：
- 新增 `isConvertingWatchOnly` 状态标记转换模式
- 新增 `convertingWalletId` 记录要转换的钱包ID
- 导入 `Trash2` 图标用于删除按钮
- 更新 `importWallet` 函数支持转换模式

## 6. 相关文档

- [iOS OCR 集成文档](./iOS_OCR_INTEGRATION.md)
- [离线能力说明](./OFFLINE_CAPABILITY.md)
- [钱包类型说明](../README.md#钱包类型)

## 7. 技术支持

如有问题或建议，请通过以下方式联系：

- GitHub Issues: [提交问题](https://github.com/i5am/xwallet/issues)
- 邮箱: support@xwallet.com
- 文档更新: 欢迎提交 PR 改进文档

---

**最后更新**: 2024-01-XX  
**版本**: v1.1.0  
**作者**: XWallet Development Team
